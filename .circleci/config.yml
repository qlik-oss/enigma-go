aliases:

  - &build
      go build

  - &lint |
      LINT_VER=1.45.2
      go fmt ./...
      @stat ./bin/golangci-lint > /dev/null && ./bin/golangci-lint --version | grep -q $LINT_VER || (echo "Installing golangci-lint" && curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v$LINT_VER)
      ./bin/golangci-lint run
      # go fmt and golint can alter go.mod and go.sum.
      # This will cause the git diff to give false negative.
      # Restore those files before proceeding to avoid side effect.
      git checkout go.mod go.sum
      git diff --exit-code

  - &test
      make test-unit

  - &spec_test |
      go test -v -race ./spec
      set +e # If we don't have any tags we will get exit code 128.
      TAG=$(git describe --tags --abbrev=0 2> /dev/null)
      set -e # Reset -e just in case
      if [[ ! -z $TAG && ($(git rev-list -n 1 $TAG) == $(git rev-parse HEAD)) ]]; then
        go run ./spec/generate.go -version $TAG
      else
        go run ./spec/generate.go
      fi
      git diff --exit-code api-spec.json

  - &examples |
      ./examples/run_examples.sh

version: 2
jobs:
  generate-schema:
    docker:
      - image: circleci/golang:1.16
    environment:
      GOLANG_VERSION: "1.16"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.16{{ checksum "go.sum" }}
      - run: ./schema/generate.sh
  golang-1.13:
    requires:
      - generate-schema
    docker:
      - image: cimg/go:1.13
    environment:
      GOLANG_VERSION: "1.13"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.13{{ checksum "go.sum" }}
      - run: *build
      - save_cache:
          key: dependency-cache-1.13{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: *lint
      - run: *test
      - run: *spec_test
      - run: go test -v -race ./release/verval
      - run: *examples

  golang-1.14:
    requires:
      - generate-schema
    docker:
      - image: cimg/go:1.14
    environment:
      GOLANG_VERSION: "1.14"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.14{{ checksum "go.sum" }}
      - run: *build
      - save_cache:
          key: dependency-cache-1.14{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: *lint
      - run: *test
      - run: *spec_test
      - run: go test -v -race ./release/verval
      - run: *examples

  golang-1.15:
    requires:
      - generate-schema
    docker:
      - image: cimg/go:1.15
    environment:
      GOLANG_VERSION: "1.15"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.15{{ checksum "go.sum" }}
      - run: *build
      - save_cache:
          key: dependency-cache-1.15{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: *lint
      - run: *test
      - run: *spec_test
      - run: go test -v -race ./release/verval
      - run: *examples

  golang-1.16:
    requires:
      - generate-schema
    docker:
      - image: cimg/go:1.16
    environment:
      GOLANG_VERSION: "1.16"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.16{{ checksum "go.sum" }}
      - run: *build
      - save_cache:
          key: dependency-cache-1.16{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: *lint
      - run: *test
      - run: *spec_test
      - run: go test -v -race ./release/verval
      - run: *examples

  golang-1.17:
    requires:
      - generate-schema
    docker:
      - image: cimg/go:1.17
    environment:
      GOLANG_VERSION: "1.17"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.17{{ checksum "go.sum" }}
      - run: *build
      - save_cache:
          key: dependency-cache-1.17{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: *lint
      - run: *test
      - run: *spec_test
      - run: go test -v -race ./release/verval
      - run: *examples

  golang-1.18:
    requires:
      - generate-schema
    docker:
      - image: cimg/go:1.18
    environment:
      GOLANG_VERSION: "1.18"
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-1.18{{ checksum "go.sum" }}
      - run: *build
      - save_cache:
          key: dependency-cache-1.18{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: *lint
      - run: *test
      - run: *spec_test
      - run: go test -v -race ./release/verval
      - run: *examples
  

workflows:
  version: 2
  build:
    jobs:
      - generate-schema
      - golang-1.13:
          filters:
            tags:
              only:
                - /v.*/
      - golang-1.14:
          filters:
            tags:
              only:
                - /v.*/
      - golang-1.15:
          filters:
            tags:
              only:
                - /v.*/
      - golang-1.16:
          filters:
            tags:
              only:
                - /v.*/
      - golang-1.17:
          filters:
            tags:
              only:
                - /v.*/
      - golang-1.18:
          filters:
            tags:
              only:
                - /v.*/
